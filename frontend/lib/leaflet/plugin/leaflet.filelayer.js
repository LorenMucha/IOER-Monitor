!function(e,t){"function"==typeof define&&define.amd&&t.toGeoJSON?define(["frontend/lib/leaflet/leaflet"],function(i){e(i,t.toGeoJSON)}):"object"==typeof module&&module.exports?module.exports=function(i, o, r){return void 0===o&&(o=void 0!==t?require("frontend/lib/leaflet/leaflet"):require("frontend/lib/leaflet/leaflet")(i)),void 0===r&&(r=void 0!==t?require("frontend/lib/leaflet/plugin/togeojson"):require("frontend/lib/leaflet/plugin/togeojson")(i)),e(o,r),o}:void 0!==t&&t.L&&t.toGeoJSON&&e(t.L,t.toGeoJSON)}(function(e, t){var i=e.Class.extend({includes:e.Mixin.Events,options:{layer:e.geoJson,layerOptions:{},fileSizeLimit:1024},initialize:function(t, i){this._map=t,e.Util.setOptions(this,i),this._parsers={geojson:this._loadGeoJSON,json:this._loadGeoJSON,gpx:this._convertToGeoJSON,kml:this._convertToGeoJSON}},load:function(t, i){var o,r;return!this._isParameterMissing(t,"file")&&(!!this._isFileSizeOk(t.size)&&(!!(o=this._getParser(t.name,i))&&(r=new FileReader,r.onload=e.Util.bind(function(e){var i;try{this.fire("data:loading",{filename:t.name,format:o.ext}),i=o.processor.call(this,e.target.result,o.ext),this.fire("data:loaded",{layer:i,filename:t.name,format:o.ext})}catch(e){this.fire("data:error",{error:e})}},this),t.testing||r.readAsText(t),r)))},loadMultiple:function(e,t){var i=[];if(e[0])for(e=Array.prototype.slice.apply(e);e.length>0;)i.push(this.load(e.shift(),t));return i},loadData:function(e,t,i){var o,r;if(!this._isParameterMissing(e,"data")&&!this._isParameterMissing(t,"name")&&this._isFileSizeOk(e.length)&&(o=this._getParser(t,i)))try{this.fire("data:loading",{filename:t,format:o.ext}),r=o.processor.call(this,e,o.ext),this.fire("data:loaded",{layer:r,filename:t,format:o.ext})}catch(e){this.fire("data:error",{error:e})}},_isParameterMissing:function(e,t){return void 0===e&&(this.fire("data:error",{error:new Error("Missing parameter: "+t)}),!0)},_getParser:function(e,t){var i;if(t=t||e.split(".").pop(),i=this._parsers[t])return{processor:i,ext:t};this.fire("data:error",{error:new Error("Unsupported file type ("+t+")")})},_isFileSizeOk:function(e){var t=(e/1024).toFixed(4);return!(t>this.options.fileSizeLimit)||(this.fire("data:error",{error:new Error("File size exceeds limit ("+t+" > "+this.options.fileSizeLimit+"kb)")}),!1)},_loadGeoJSON:function(e){var t;if("string"==typeof e&&(e=JSON.parse(e)),0===(t=this.options.layer(e,this.options.layerOptions)).getLayers().length)throw new Error("GeoJSON has no valid layers.");return this.options.addToMap&&t.addTo(this._map),t},_convertToGeoJSON:function(e,i){var o;return"string"==typeof e&&(e=(new window.DOMParser).parseFromString(e,"text/xml")),o=t[i](e),this._loadGeoJSON(o)}}),o=e.Control.extend({statics:{TITLE:"Load local file (GPX, KML, GeoJSON)",LABEL:""},options:{position:"topleft",fitBounds:!0,layerOptions:{},addToMap:!0,fileSizeLimit:1024},initialize:function(t){e.Util.setOptions(this,t),this.loader=null},onAdd:function(t){return this.loader=e.Util.fileLoader(t,this.options),this.loader.on("data:loaded",function(e){this.options.fitBounds&&window.setTimeout(function(){t.fitBounds(e.layer.getBounds())},500)},this),this._initDragAndDrop(t),this._initContainer()},_initDragAndDrop:function(e){var t,i=this.loader,o=e._container,r={dragenter:function(){e.scrollWheelZoom.disable()},dragleave:function(){e.scrollWheelZoom.enable()},dragover:function(e){e.stopPropagation(),e.preventDefault()},drop:function(t){t.stopPropagation(),t.preventDefault(),i.loadMultiple(t.dataTransfer.files),e.scrollWheelZoom.enable()}};for(t in r)r.hasOwnProperty(t)&&o.addEventListener(t,r[t],!1)},_initContainer:function(){var t,i=this.loader,o="leaflet-control-filelayer leaflet-control-zoom",r=e.DomUtil.create("div",o+" leaflet-bar"),n=e.DomUtil.create("a",o+"-in leaflet-bar-part",r);return n.innerHTML=e.Control.FileLayerLoad.LABEL,n.href="#",n.title=e.Control.FileLayerLoad.TITLE,t=e.DomUtil.create("input","hidden",r),t.type="file",t.multiple="multiple",this.options.formats?t.accept=this.options.formats.join(","):t.accept=".gpx,.kml,.geojson",t.style.display="none",t.addEventListener("change",function(){i.loadMultiple(this.files),this.value=""},!1),e.DomEvent.disableClickPropagation(n),e.DomEvent.on(n,"click",function(e){t.click(),e.preventDefault()}),r}});e.Util.FileLoader=i,e.Util.fileLoader=function(t,i){return new e.Util.FileLoader(t,i)},e.Control.FileLayerLoad=o,e.Control.fileLayerLoad=function(t){return new e.Control.FileLayerLoad(t)}},window);